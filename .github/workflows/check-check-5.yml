name: Autocheck 5 lesson

on:
  push:
  workflow_dispatch:

jobs:
  compare:
    runs-on: ubuntu-latest

    env:
      REFERENCE_REPO: intensive-front/l5ref
      # STRICT=true  -> –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Å—Ç—Ä–æ–≥–æ (–∫—Ä–æ–º–µ CRLF –∏ BOM)
      # STRICT=false -> –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–µ–ª—ã –≤ –∫–æ–Ω—Ü–µ —Å—Ç—Ä–æ–∫ + –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ –∫–æ–Ω—Ü–µ —Ñ–∞–π–ª–∞
      STRICT: "false"

    steps:
      - name: clone repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: clone ref
        uses: actions/checkout@v4
        with:
          repository: ${{ env.REFERENCE_REPO }}
          path: reference
          fetch-depth: 1

      - name: check structure + diff (diff –≤ Summary)
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob

          # =====================================================
          # –°–ü–ò–°–û–ö 1 ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã (–¢–û–õ–¨–ö–û –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è)
          # =====================================================
          FILES_REQUIRED=(
            "src/index.html"
            "src/main.ts"
            "src/styles.css"
            "src/app/app.config.ts"
            "src/app/app.routes.ts"
            "src/app/header/header.css"
            "src/app/header/header.html"
            "src/app/header/header.ts"
            "src/app/pages/home/home.css"
            "src/app/pages/home/home.html"
            "src/app/pages/home/home.ts"
            "src/app/pages/order/order.css"
            "src/app/pages/order/order.html"
            "src/app/pages/order/order.ts"
            "src/app/pages/order/order.config.ts"
            "src/app/pages/track/track.css"
            "src/app/pages/track/track.html"
            "src/app/pages/track/track.ts"
            "public/fonts/Roboto-Bold.ttf"
            "public/fonts/Roboto-Medium.ttf"
            "public/fonts/Roboto-Regular.ttf"
            "public/images/icons/regular.svg"
            "public/images/icons/fast.svg"
            "public/images/icons/created.svg"
            "public/images/icons/in-way.svg"
            "public/images/icons/ready.svg"
            "public/images/icons/done.svg"
            "public/images/track-bg.png"
            "public/images/order-bg.png"
            "public/images/main-image.png"
            "public/images/sizes/xs.png"
            "public/images/sizes/s.png"
            "public/images/sizes/m.png"
            "public/images/sizes/l.png"
            "public/images/sizes/xl.png"
            "public/images/sizes/max.png"
          )

          # =====================================================
          # –°–ü–ò–°–û–ö 2 ‚Äî —Ñ–∞–π–ª—ã –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ (diff)
          # =====================================================
          FILES_COMPARE=(
            "src/index.html"
            "src/main.ts"
            "src/styles.css"
            "src/app/app.config.ts"
            "src/app/app.routes.ts"
            "src/app/header/header.css"
            "src/app/header/header.html"
            "src/app/header/header.ts"
            "src/app/pages/home/home.css"
            "src/app/pages/home/home.html"
            "src/app/pages/home/home.ts"
            "src/app/pages/order/order.css"
            "src/app/pages/order/order.html"
            "src/app/pages/order/order.ts"
            "src/app/pages/order/order.config.ts"
            "src/app/pages/track/track.css"
            "src/app/pages/track/track.html"
            "src/app/pages/track/track.ts"
          )

          mkdir -p .norm/ref .norm/student .diffs report

          normalize_strict() {
            local src="$1"
            local dst="$2"
            mkdir -p "$(dirname "$dst")"
            awk '
              NR==1 { sub(/^\xEF\xBB\xBF/, "") }
              { sub(/\r$/, ""); print }
            ' "$src" > "$dst"
          }

          normalize_tolerant() {
            local src="$1"
            local dst="$2"
            mkdir -p "$(dirname "$dst")"
            awk '
              NR==1 { sub(/^\xEF\xBB\xBF/, "") }
              {
                sub(/\r$/, "");
                sub(/[ \t]+$/, "");
                lines[NR] = $0;
                last = NR;
              }
              END {
                while (last > 0 && lines[last] == "") last--;
                for (i = 1; i <= last; i++) print lines[i];
              }
            ' "$src" > "$dst"
          }

          normalize() {
            if [[ "${STRICT}" == "true" ]]; then
              normalize_strict "$1" "$2"
            else
              normalize_tolerant "$1" "$2"
            fi
          }

          failed=0

          # =====================================================
          # –ò—Ç–æ–≥ –ø—Ä–æ–≤–µ—Ä–∫–∏ (–§–ê–ô–õ: –ø—Ä–æ–±–ª–µ–º–∞)
          # =====================================================
          RESULT_LINES=()
          add_result_line() {
            local line="$1"
            RESULT_LINES+=("$line")
          }

          render_result() {
            {
              echo
              echo "## –ò—Ç–æ–≥ –ø—Ä–æ–≤–µ—Ä–∫–∏"
              echo
              if (( ${#RESULT_LINES[@]} == 0 )); then
                echo "<p><strong>–û–®–ò–ë–û–ö –ù–ï –ù–ê–ô–î–ï–ù–û</strong></p>"
              else
                echo "<pre>"
                printf '%s\n' "${RESULT_LINES[@]}"
                echo "</pre>"
              fi
              echo
            } >> "$GITHUB_STEP_SUMMARY"
          }

          # -------------------- SUMMARY HEADER --------------------
          {
            echo "# üß™ —á–µ–∫-—á–µ–∫"
            echo
          } >> "$GITHUB_STEP_SUMMARY"

          # =====================================================
          # –®–ê–ì 1 ‚Äî –ü–†–û–í–ï–†–ö–ê –ù–ê–õ–ò–ß–ò–Ø –§–ê–ô–õ–û–í
          # =====================================================
          {
            echo "## –§–∞–π–ª—ã"
            echo
          } >> "$GITHUB_STEP_SUMMARY"

          for f in "${FILES_REQUIRED[@]}"; do
            if [[ -f "$f" ]]; then
              echo "- ‚úÖ \`$f\` ‚Äî –Ω–∞–π–¥–µ–Ω" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "::error file=$f::–§–∞–π–ª –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
              echo "- ‚ùå \`$f\` ‚Äî –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç" >> "$GITHUB_STEP_SUMMARY"
              add_result_line "$f: —Ñ–∞–π–ª –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
              failed=1
            fi
          done

          # =====================================================
          # –®–ê–ì 2 ‚Äî –°–æ–¥–µ—Ä–∂–∏–º–æ–µ
          # =====================================================
          {
            echo
            echo "## –°–æ–¥–µ—Ä–∂–∏–º–æ–µ"
            echo
            echo "### –ö–∞–∫ —á–∏—Ç–∞—Ç—å diff"
            echo "- —Å—Ç—Ä–æ–∫–∏ —Å **\`-\`** ‚Äî –∫–∞–∫ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ —ç—Ç–∞–ª–æ–Ω–µ"
            echo "- —Å—Ç—Ä–æ–∫–∏ —Å **\`+\`** ‚Äî –∫–∞–∫ —Å–¥–µ–ª–∞–Ω–æ"
            echo
            echo "## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å—Ä–∞–≤–Ω–µ–Ω–∏—è"
            echo
          } >> "$GITHUB_STEP_SUMMARY"

          for f in "${FILES_COMPARE[@]}"; do
            # –ï—Å–ª–∏ –Ω–µ—Ç —Ñ–∞–π–ª–∞ —É —É—á–µ–Ω–∏–∫–∞
            if [[ ! -f "$f" ]]; then
              echo "::error file=$f::–ù–µ–ª—å–∑—è —Å—Ä–∞–≤–Ω–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ ‚Äî —Ñ–∞–π–ª–∞ –Ω–µ—Ç"
              echo "- ‚ùå \`$f\` ‚Äî –Ω–µ —Å—Ä–∞–≤–Ω–∏–≤–∞–ª—Å—è (—Ñ–∞–π–ª –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)" >> "$GITHUB_STEP_SUMMARY"
              add_result_line "$f: —Ñ–∞–π–ª –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
              failed=1
              continue
            fi

            # –ï—Å–ª–∏ –Ω–µ—Ç —Ñ–∞–π–ª–∞ –≤ —ç—Ç–∞–ª–æ–Ω–µ ‚Äî –ø—Ä–æ–±–ª–µ–º–∞ —ç—Ç–∞–ª–æ–Ω–∞
            if [[ ! -f "reference/$f" ]]; then
              echo "::error file=reference/$f::–§–∞–π–ª –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —ç—Ç–∞–ª–æ–Ω–µ"
              echo "- ‚ùå \`$f\` ‚Äî –Ω–µ —Å—Ä–∞–≤–Ω–∏–≤–∞–ª—Å—è (–Ω–µ—Ç —Ñ–∞–π–ª–∞ –≤ —ç—Ç–∞–ª–æ–Ω–µ)" >> "$GITHUB_STEP_SUMMARY"
              add_result_line "$f: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —ç—Ç–∞–ª–æ–Ω–µ (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ REFERENCE_REPO)"
              failed=1
              continue
            fi

            normalize "reference/$f" ".norm/ref/$f"
            normalize "$f" ".norm/student/$f"

            diff_file=".diffs/${f//\//_}.diff"

            if diff -u -w -B ".norm/ref/$f" ".norm/student/$f" > "$diff_file"; then
              echo "- ‚úÖ \`$f\` ‚Äî —Å–æ–≤–ø–∞–¥–∞–µ—Ç" >> "$GITHUB_STEP_SUMMARY"
              rm -f "$diff_file"
            else
              echo "::error file=$f::–ö–æ–¥ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —ç—Ç–∞–ª–æ–Ω–æ–º"
              echo "- ‚ùå \`$f\` ‚Äî –µ—Å—Ç—å –æ—Ç–ª–∏—á–∏—è" >> "$GITHUB_STEP_SUMMARY"
              failed=1

              {
                echo
                echo "### Diff: \`$f\` (—Ñ—Ä–∞–≥–º–µ–Ω—Ç)"
                echo
                echo "\`\`\`diff"
                head -n 200 "$diff_file"
                echo "\`\`\`"
                if [[ $(wc -l < "$diff_file") -gt 200 ]]; then
                  echo
                  echo "_–ü–æ–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–≤—ã–µ 200 —Å—Ç—Ä–æ–∫. –ü–æ–ª–Ω—ã–π HTML-–æ—Ç—á—ë—Ç ‚Äî –≤ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–µ **autocheck-report**._"
                fi
                echo
              } >> "$GITHUB_STEP_SUMMARY"

              # "–º–µ—Å—Ç–∞" –æ—Ç–ª–∏—á–∏–π = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ hunks (@@ ... @@)
              diff_count="$(grep -c '^@@' "$diff_file" || true)"
              if [[ "$diff_count" -le 0 ]]; then diff_count=1; fi

              add_result_line "$f: –∫–æ–¥ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —ç—Ç–∞–ª–æ–Ω–æ–º (${diff_count} –º–µ—Å—Ç)"
            fi
          done

          # =====================================================
          # –°–ë–û–†–ö–ê –û–ë–©–ï–ì–û DIFF –î–õ–Ø HTML
          # =====================================================
          diff_files=( .diffs/*.diff )
          if (( ${#diff_files[@]} > 0 )); then
            cat "${diff_files[@]}" > report/all.diff
          else
            : > report/all.diff
          fi

          echo "$failed" > report/failed.flag

          # ‚úÖ –í–´–í–û–î–ò–ú –ò–¢–û–ì (–≤–∞–∂–Ω–æ: –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫)
          render_result

          {
            echo
            echo "## –ù–∏–∂–µ –≤ —Ä–∞–∑–¥–µ–ª–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ (Artifacts) ‚Äì –ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ —á–µ–∫-—á–µ–∫—É"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: HTML-report (diff2html)
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          if [[ ! -s report/all.diff ]]; then
            echo "<html><body style='font-family:system-ui;padding:24px'><h2>‚úÖ –û—Ç–ª–∏—á–∏–π –ø–æ –∫–æ–¥—É –Ω–µ—Ç</h2><p>–í—Å–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º—ã–µ —Ñ–∞–π–ª—ã —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å —ç—Ç–∞–ª–æ–Ω–æ–º.</p></body></html>" > report/report.html
            exit 0
          fi

          npm i -g diff2html-cli
          diff2html -i file -F report/report.html -- report/all.diff

      - name: load HTML-report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: autocheck-report
          path: report

      - name: Fail if errors
        shell: bash
        run: |
          set -euo pipefail
          failed="$(cat report/failed.flag || echo 1)"
          if [[ "$failed" != "0" ]]; then
            echo "–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏. –°–º–æ—Ç—Ä–∏—Ç–µ Summary –∏ HTML-–æ—Ç—á—ë—Ç."
            exit 1
          fi
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ ‚úÖ"
